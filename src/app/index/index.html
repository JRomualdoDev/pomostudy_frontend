<div class="space-y-4 m-6 p-6">
  <div class="task-form-container-horizontal flex">
    <div class="flex-1" style="border-right: 1px solid #e3eaf3; padding-right: 16px;">
      <full-calendar #calendar [options]="calendarOptions" [events]="eventsPromise | async" style="height: 600px;"></full-calendar>
    </div>
    <div class="flex-1" style="padding-left: 16px;">
      <form (ngSubmit)="submitTask()" autocomplete="off" class="task-form-horizontal">
        <div class="form-row">
          <z-form-field label="Name">
            <input z-input class="input" name="name" [(ngModel)]="task.name" placeholder="Name" required />
          </z-form-field>
          <z-form-field label="Description">
            <input z-input class="input" name="description" [(ngModel)]="task.description" placeholder="Description" />
          </z-form-field>
          <z-form-field label="Start Date">
            <input z-input class="input" type="date" name="startDate" [(ngModel)]="task.startDate" placeholder="Start Date" style="min-width:220px;max-width:220px;" />
          </z-form-field>
          <z-form-field label="End Date">
            <input z-input class="input" type="date" name="endDate" [(ngModel)]="task.endDate" placeholder="End Date" style="min-width:220px;max-width:220px;" />
          </z-form-field>
          <z-form-field label="Status">
            <z-select 
              zPlaceholder="Status" 
              name="status" 
              [(ngModel)]="task.status" 
              required 
              style="min-width:100px;max-width:100px;"
            >
              <z-select-item zValue="PENDING">Pending</z-select-item>
              <z-select-item zValue="IN_PROGRESS">In Progress</z-select-item>
              <z-select-item zValue="COMPLETED">Completed</z-select-item>
              <z-select-item zValue="CANCELED">Canceled</z-select-item>
            </z-select>
          </z-form-field>
          <z-form-field label="Priority">
            <z-select zPlaceholder="Priority" name="priority" [(ngModel)]="task.priority" required style="min-width:100px;max-width:100px;">
              <z-select-item zValue="LOW">Low</z-select-item>
              <z-select-item zValue="MEDIUM">Medium</z-select-item>
              <z-select-item zValue="HIGH">High</z-select-item>
            </z-select>
          </z-form-field>
          <z-form-field label="Category">
            <div class="flex items-center space-x-2">
              @if (uniqueCategories.length > 0) {
                <z-select 
                  id="categoryId" 
                  name="categoryId" 
                  [(ngModel)]="task.categoryId"
                  required 
                  zPlaceholder="Categories" 
                  style="min-width:120px;max-width:120px;"
                >
                  @for (cat of uniqueCategories; track cat.id) {
                    <z-select-item [zValue]="cat.id">{{ cat.name }}</z-select-item>
                  }
                </z-select>
              } @else {
                <div>Loading categories...</div>
              }
              <ng-template #categoryPopup>
                <z-popover>
                  <div class="category-popover-content" style="min-width:260px;max-width:340px;">
                    <div class="category-popover-header">
                      <h4>New Category</h4>
                      <p>Add a new category below.</p>
                    </div>
                    <div class="category-popover-field">
                      <label for="catName">Category Name</label>
                      <input id="catName" z-input name="catName" [(ngModel)]="category.name" placeholder="Category Name" />
                    </div>
                    <div class="category-popover-field">
                      <label for="catColor">Color (hex)</label>
                      <input id="catColor" z-input name="catColor" [(ngModel)]="category.color" placeholder="Color (hex)" />
                    </div>
                    <div class="category-popover-field">
                      <label for="catIcon">Icon</label>
                      <input id="catIcon" z-input name="catIcon" [(ngModel)]="category.icon" placeholder="Icon (class or image)" />
                    </div>
                    <button type="button" z-button class="category-popover-btn" zSize="sm" (click)="submitCategory()">
                      <i class="fa fa-save"></i> Save Category
                    </button>
                  </div>
                </z-popover>
              </ng-template>
              <button 
                type="button" 
                z-button 
                zPopover
                zType="ghost" 
                class="new-category-btn" 
                title="Add Category"
                [zContent]="categoryPopup"
                #popoverTrigger
              >
                <i class="fa fa-circle-plus"></i>
              </button>
            </div>
          </z-form-field>
          <z-form-field>
            <button type="submit" z-button zType="secondary" class="save-task-btn">
              <i class="fa fa-plus"></i>
              Create Task
            </button>
          </z-form-field>
        </div>
        @if (dateError) {
          <div class="msg" style="color:#e53e3e;">Start Date cannot be after End Date and End Date cannot be before Start Date.</div>
        }
        @if (message) {
          <div class="msg">{{ message }}</div>
        }
      </form>
    </div>
  </div>

  <div class="task-table-container">
    <div class="form-field flex flex-col mb-16 space-y-" style="max-width: 300px; ">
      <label>Show tasks In Progress:</label>
      @if (uniqueCategories.length > 0) {
      <z-select 
        zPlaceholder="Tasks" 
        [(ngModel)]="selectedCategoryId"
        (ngModelChange)="selectedCategoryId = $event; onCategorySelect($event)"
        name="selectedCategoryId"
        style="min-width:80px;max-width:80px;"
      >
        <ng-container *ngFor="let cat of uniqueCategories; trackBy: trackById">
          <z-select-item [zValue]="cat.id">{{ cat.name }}</z-select-item>
        </ng-container>
      </z-select>
      } @else {
          <div>Loading categories...</div>
        }
    </div>
    @if (filteredTasks.length > 0) {
      <table class="elegant-table">
        <thead>
          <tr>
            <th></th>
            <th>Name</th>
            <th>Description</th>
            <th>Start Date</th>
            <th>End Date</th>
            <th>Status</th>
            <th>Priority</th>
            <th>Total Learning Time</th>
          </tr>
        </thead>
        <tbody>
          @for (task of filteredTasks; track task.id) {
            <tr>
              <td>
                <button z-button zType="ghost" class="play-btn" (click)="openPomodoro(task)">
                  <i class="icon-play"></i>
                </button>
              </td>
              <td>{{ task.name }}</td>
              <td>{{ task.description }}</td>
              <td>{{ task.startDate ? (task.startDate | date:'MM/dd/yyyy') : '' }}</td>
              <td>{{ task.endDate ? (task.endDate | date:'MM/dd/yyyy') : '' }}</td>
              <td>
                <z-badge class="w-22 flex justify-center"
                  [zType]="
                    task.status === 'PENDING' ? 'outline' :
                    task.status === 'IN_PROGRESS' ? 'secondary' :
                    task.status === 'COMPLETED' ? 'default' :
                    task.status === 'CANCELED' ? 'destructive' : 'destructive'
                  ">
                  {{
                    task.status === 'PENDING' ? 'Pending' :
                    task.status === 'IN_PROGRESS' ? 'In Progress' :
                    task.status === 'COMPLETED' ? 'Completed' :
                    task.status === 'CANCELED' ? 'Canceled' : task.status
                  }}
                </z-badge>
              </td>
              <td>
                <z-badge class="w-22 flex justify-center"
                  zShape="square"
                  [zType]="
                    task.priority === 'LOW' ? 'outline' :
                    task.priority === 'MEDIUM' ? 'secondary' :
                    task.priority === 'HIGH' ? 'destructive' : 'default'
                  ">
                  {{
                    task.priority === 'LOW' ? 'Low' :
                    task.priority === 'MEDIUM' ? 'Medium' :
                    task.priority === 'HIGH' ? 'High' : task.priority
                  }}
                </z-badge>
              </td>
              <td>{{ task.timeTotalLearning }}</td>
            </tr>
          }
        </tbody>
      </table>
    }
    @if (selectedCategoryId && filteredTasks.length === 0) {
      <div class="msg">
        No tasks in progress found for this category.
      </div>
    }
  </div>

  <!-- Pomodoro Fullscreen Popup -->
  @if (showPomodoro) {
    <div class="pomodoro-fullscreen">
      <app-pomodoro [task]="pomodoroTask" (close)="closePomodoro()"></app-pomodoro>
    </div>
  }
</div>
