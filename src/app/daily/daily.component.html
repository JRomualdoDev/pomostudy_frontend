<div class="daily-main-wrapper">
  <div class="daily-main-content">
    <div class="daily-header">
      <div class="daily-header-left">
        <span class="daily-title"><i class="fa fa-sun"></i> My Day</span>
        <span class="daily-date">Monday, Oct 20</span>
      </div>
      <div class="daily-header-right">
        <!-- <div class="daily-view-switch">
          <span class="active">Grid</span>
          <span>List</span>
        </div>
        <div class="daily-actions">
          <span>Sort</span>
          <span>Group</span>
          <span>Suggestions</span>
        </div> -->
      </div>
    </div>
    <div class="daily-add-task-row">
      <input 
        class="daily-add-task-input" 
        placeholder="Add a task" 
        [(ngModel)]="newTaskTitle"
        name="newTaskTitle"
        (keyup.enter)="addTask()"
      />
      <button class="daily-add-btn" (click)="addTask()">Add</button>
    </div>
    <div class="daily-table">
      <table class="elegant-table">
        <thead>
          <tr>
            <th></th>
            <th>Name</th>
            <th>Description</th>
            <th>Start Date</th>
            <th>End Date</th>
            <th>Status</th>
            <th>Priority</th>
            <th>Total Learning Time</th>
          </tr>
        </thead>
        <tbody>
          <!-- Tasks not completed -->
          <tr *ngFor="let task of tasks" [class.selected]="task.id === selectedTask?.id" (click)="onSelectTask(task)">
            <td>
               <!-- intercept changes, stop row click propagation -->
               <input 
                 type="checkbox" 
                 [checked]="task.completed" 
                 (change)="$event.stopPropagation(); task.completed = $event.target.checked"
               />
            </td>
            <td>{{ task.name }}</td>
            <td>{{ task.description || '-' }}</td>
            <td>{{ formatDateForInput(task.startDate) || '-' }}</td>
            <td>{{ formatDateForInput(task.endDate) || '-' }}</td>
            <td>
              <span>
                {{

                  task.status === 'PENDING' ? 'Pending' :
                  task.status === 'IN_PROGRESS' ? 'In Progress' :
                  task.status === 'COMPLETED' ? 'Completed' :
                  task.status === 'CANCELED' ? 'Canceled' : (task.status || '-')
                }}
              </span>
            </td>
            <td>
              <span>
                {{

                  task.priority === 'LOW' ? 'Low' :
                  task.priority === 'MEDIUM' ? 'Medium' :
                  task.priority === 'HIGH' ? 'High' : (task.priority || '-')
                }}
              </span>
            </td>
            <td>{{ task.timeTotalLearning || '-' }}</td>
          </tr>
          <!-- Completed header -->
          <tr class="daily-completed-header">
            <td colspan="8">
              <span
                class="daily-chevron"
                role="button"
                tabindex="0"
                (click)="showCompleted = !showCompleted"
                (keydown.enter)="showCompleted = !showCompleted"
                [attr.aria-expanded]="showCompleted"
                [class.collapsed]="!showCompleted"
                title="Toggle completed tasks"
              >
                {{ showCompleted ? '▼' : '▶' }}
              </span>
              <b>Completed</b> {{ completedTasks.length }}
            </td>
          </tr>
          <!-- Completed tasks -->
          <ng-container *ngIf="showCompleted">
            <tr *ngFor="let task of completedTasks" class="daily-completed-row" [class.selected]="task.id === selectedTask?.id" (click)="onSelectTask(task)">
              <td>
                <input 
                  type="checkbox" 
                  [checked]="task.completed" 
                  (change)="$event.stopPropagation(); task.completed = $event.target.checked" 
                />
              </td>
              <td>
                <span class="daily-completed-text">{{ task.name }}</span>
              </td>
              <td>{{ formatDateForInput(task.description) || '-' }}</td>
              <td>{{ formatDateForInput(task.startDate) || '-' }}</td>
              <td>{{ formatDateForInput(task.endDate) || '-' }}</td>
              <td>
                <span>
                  {{

                    task.status === 'PENDING' ? 'Pending' :
                    task.status === 'IN_PROGRESS' ? 'In Progress' :
                    task.status === 'COMPLETED' ? 'Completed' :
                    task.status === 'CANCELED' ? 'Canceled' : (task.status || '-')
                  }}
                </span>
              </td>
              <td>
                <span>
                  {{

                    task.priority === 'LOW' ? 'Low' :
                    task.priority === 'MEDIUM' ? 'Medium' :
                    task.priority === 'HIGH' ? 'High' : (task.priority || '-')
                  }}
                </span>
              </td>
              <td>{{ task.timeTotalLearning || '-' }}</td>
            </tr>
          </ng-container>
        </tbody>
      </table>
    </div>
  </div>
  <div class="daily-sidebar">
    <div class="daily-task-detail">
      <div class="daily-task-title">
        <input type="checkbox" [checked]="selectedTask.completed" />
        <b>{{ selectedTask.name }}</b>
        <i class="fa fa-star daily-star" [class.filled]="selectedTask.important"></i>
      </div>
      <div class="daily-task-actions">
        <!-- <div><i class="fa fa-sync"></i> Repeats weekly <span class="daily-task-repeat">Tue, Thu & Sat</span></div> -->

        <!-- Category chooser: button opens popover with select populated from backend categories -->
        <div class="category-chooser">
          <button z-button zType="ghost" class="choose-cat-btn" zPopover [zContent]="categoryPopup" title="Choose category" #categoryPopoverTrigger>
            <i class="fa fa-tag" style="margin-right:8px"></i>
            {{ getDisplayedCategoryName()}}
          </button>
          <ng-template #categoryPopup>
            <z-popover>
              <div style="min-width:240px; max-width:340px; padding:12px;">
                <h4 style="margin:0 0 8px 0;">Select Category</h4>
                <z-select zPlaceholder="Categories" [(ngModel)]="sidebarTask.categoryId"
                  (ngModelChange)="onSidebarCategorySelect($event, categoryPopoverTrigger)">
                  <ng-container *ngFor="let cat of categories">
                    <z-select-item [zValue]="cat.id">{{ cat.name }}</z-select-item>
                  </ng-container>
                </z-select>
                <div style="margin-top:12px; display:flex; justify-content:flex-end;">
                  <z-button zSize="sm" zType="secondary" (click)="$any(this).closeCategoryPopover(categoryPopoverTrigger)">Done</z-button>
                </div>
              </div>
            </z-popover>
          </ng-template>
        </div>

        <div><i class="fa fa-sticky-note"></i> Add note</div>
      </div>

      <!-- Sidebar create task form (name, description, startDate, endDate, status, priority) -->
      <form (ngSubmit)="createTaskFromSidebar()" class="sidebar-create-form" autocomplete="off" style="margin-top:16px;">
        <z-form-field label="Name">
          <input z-input name="sidebarName" [(ngModel)]="sidebarTask.name" placeholder="Name" required />
        </z-form-field>

        <z-form-field label="Description" style="margin-top:8px;">
          <input z-input name="sidebarDescription" [(ngModel)]="sidebarTask.description" placeholder="Description" />
        </z-form-field>

        <div style="display:flex;gap:8px;">
          <z-form-field label="Start Date" style="flex:1; width: 50px;">
            <input z-input type="date" name="sidebarStart" [(ngModel)]="sidebarTask.startDate" />
          </z-form-field>
          <z-form-field label="End Date" style="flex:1; width: 50px;">
            <input z-input type="date" name="sidebarEnd" [(ngModel)]="sidebarTask.endDate" />
          </z-form-field>
        </div>

        <div style="display:flex;gap:8px;align-items:end;">
          <z-form-field label="Status" style="flex:1;">
            <z-select class="sidebar-select" name="sidebarStatus" [(ngModel)]="sidebarTask.status" zPlaceholder="Status">
              <z-select-item zValue="PENDING">Pending</z-select-item>
              <z-select-item zValue="IN_PROGRESS">In Progress</z-select-item>
              <z-select-item zValue="COMPLETED">Completed</z-select-item>
              <z-select-item zValue="CANCELED">Canceled</z-select-item>
            </z-select>
          </z-form-field>
          <z-form-field label="Priority" style="flex:1;">
            <z-select class="sidebar-select" name="sidebarPriority" [(ngModel)]="sidebarTask.priority" zPlaceholder="Priority">
              <z-select-item zValue="LOW">Low</z-select-item>
              <z-select-item zValue="MEDIUM">Medium</z-select-item>
              <z-select-item zValue="HIGH">High</z-select-item>
            </z-select>
          </z-form-field>
        </div>

        <!-- Update Task button -->
        <div style="margin-top:12px; display:flex; justify-content:flex-end;">
          <z-button
            zType="secondary"
            class="save-task-btn"
            (click)="updateTask()"
            [disabled]="!selectedTask?.id || !isSidebarModified()"
            [attr.aria-disabled]="!selectedTask?.id || !isSidebarModified()"
            title="Update selected task"
          >
            <i class="fa fa-save" aria-hidden="true" style="margin-right:8px;"></i>
            Update Task
          </z-button>
        </div>
      </form>
    </div>
  </div>

  <!-- Confirmation popover overlay (Zard popover used as centered modal) -->
  <ng-container *ngIf="confirmToggle">
    <div class="confirm-overlay">
      <z-popover>
        <div style="min-width:280px; padding:16px;">
          <h4 style="margin:0 0 8px 0;">Confirm</h4>
          <p style="margin:0 0 12px 0;">
            {{ confirmToggle.message }}
          </p>
          <div style="display:flex; gap:8px; justify-content:flex-end;">
            <z-button zSize="sm" zType="ghost" (click)="confirmToggle = null">Cancel</z-button>
            <z-button zSize="sm" zType="secondary" (click)="confirmToggle = null">Yes</z-button>
          </div>
        </div>
      </z-popover>
    </div>
  </ng-container>

</div>
